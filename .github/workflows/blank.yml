name: CI Pipeline

on:
  workflow_dispatch:
    inputs:
      run_push:
        description: 'Run push stage'
        required: true
        default: 'true'

jobs:
  build:
    runs-on: ubuntu-latest
    if: github.event.inputs.run_build == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
        
      - name: Build Docker image
        run: docker build -t registry.gitlab.com/nadiakhalifa/my-test-project .

  push:
    needs: build
    runs-on: ubuntu-latest
    if: github.event.inputs.run_push == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Login to GitLab Registry
        uses: docker/login-action@v2
        with:
          registry: registry.gitlab.com
          username: ${{ secrets.CI_REGISTRY_USER }}
          password: ${{ secrets.CI_GITLAB_TOKEN }}
        
      - name: Push Docker image
        run: docker push registry.gitlab.com/nadiakhalifa/my-test-project

  deploy:
    needs: push
    runs-on: ubuntu-latest
    if: github.event.inputs.run_deploy == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
        
      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 172.23.5.207 >> ~/.ssh/known_hosts

      - name: Login to GitLab Registry
        uses: docker/login-action@v2
        with:
          registry: registry.gitlab.com
          username: ${{ secrets.CI_REGISTRY_USER }}
          password: ${{ secrets.CI_GITLAB_TOKEN }}
        
      - name: Pull Docker image
        run: docker pull registry.gitlab.com/nadiakhalifa/my-test-project:latest
        
      - name: Deploy Docker container
        run: ssh root@172.23.5.207 "docker run -d --name my-container -p 80:80 registry.gitlab.com/nadiakhalifa/my-test-project:latest"

        run: docker build -t registry.gitlab.com/nadiakhalifa/my-test-project .

